<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒè½¨åˆ¶å›¢é˜Ÿç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 60px; /* ä¸ºåº•éƒ¨çŠ¶æ€æ ç•™ç©ºé—´ */
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .tree-node {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin: 8px;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .tree-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .tree-node.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tree-node.search-highlight {
            animation: searchPulse 2s ease-in-out;
        }
        
        @keyframes searchPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 217, 61, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 217, 61, 0.3); }
            100% { box-shadow: 0 0 0 0 rgba(255, 217, 61, 0.7); }
        }
        
        .tree-node.left {
            border-color: #3b82f6;
        }
        
        .tree-node.right {
            border-color: #ef4444;
        }
        
        .tree-node.root {
            border-color: #10b981;
        }
        
        .tree-children {
            margin-left: 24px;
            border-left: 2px dashed #e5e7eb;
            padding-left: 16px;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: #3b82f6;
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .scale-105 {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4">
        <!-- Header -->
        <header class="glass-morphism rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                        <i class="fas fa-network-wired text-blue-600"></i>
                        åŒè½¨åˆ¶å›¢é˜Ÿç®¡ç†ç³»ç»Ÿ
                    </h1>
                    <p class="text-gray-600 mt-2">å¯è§†åŒ–å›¢é˜Ÿç»“æ„ | åŠ¨æ€æˆå‘˜ç®¡ç† | å®æ—¶ä¸šç»©è¿½è¸ª</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveToLocal()" class="btn-success">
                        <i class="fas fa-save mr-2"></i>ä¿å­˜åˆ°ç”µè„‘
                    </button>
                    <button onclick="loadFromLocal()" class="btn-secondary">
                        <i class="fas fa-folder-open mr-2"></i>ä»ç”µè„‘åŠ è½½
                    </button>
                    <button onclick="exportData()" class="btn-secondary">
                        <i class="fas fa-file-excel mr-2"></i>å¯¼å‡ºExcel
                    </button>
                    <button onclick="importData()" class="btn-primary">
                        <i class="fas fa-file-excel mr-2"></i>å¯¼å…¥Excel
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šå›¢é˜Ÿç»“æ„æ ‘ -->
            <div class="lg:col-span-2 glass-morphism rounded-2xl p-6 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-sitemap text-blue-600 mr-2"></i>
                        å›¢é˜Ÿç»“æ„å›¾
                    </h2>
                    <div class="flex gap-2">
                    <button onclick="expandAll()" class="btn-primary text-sm px-3 py-1">
                        <i class="fas fa-plus mr-1"></i>å±•å¼€
                    </button>
                    <button onclick="collapseAll()" class="btn-secondary text-sm px-3 py-1">
                        <i class="fas fa-minus mr-1"></i>æŠ˜å 
                    </button>
                    <button onclick="resetView()" class="btn-secondary text-sm px-3 py-1">
                        <i class="fas fa-redo mr-1"></i>é‡ç½®
                    </button>
                    <button onclick="clearSearch()" class="btn-secondary text-sm px-3 py-1">
                        <i class="fas fa-eraser mr-1"></i>æ¸…ç©º
                    </button>
                    </div>
                </div>

                <!-- æœç´¢æ¡† -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="æœç´¢æˆå‘˜å§“åæˆ–IDï¼Œä¾‹å¦‚ï¼šé¾šæ¶›" 
                               class="form-input pr-24" 
                               oninput="handleSearchInput(this.value)"
                               onfocus="showSearchDropdown()"
                               onblur="hideSearchDropdown()"
                               onkeypress="handleSearchKeyPress(event)">
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex gap-1">
                            <button type="button" onclick="toggleSearchDropdown()" 
                                    class="text-gray-400 hover:text-gray-600 p-1" title="å±•å¼€/æ”¶èµ·">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button type="button" onclick="executeSearch()" 
                                    class="text-blue-500 hover:text-blue-700 p-1" title="æœç´¢">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="searchDropdown" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto z-50 hidden mt-1">
                            <div class="p-2 border-b bg-gray-50">
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    æŒ‰å›è½¦æˆ–ç‚¹å‡»æœç´¢æŒ‰é’®æŸ¥æ‰¾æˆå‘˜
                                </div>
                            </div>
                            <div id="searchOptions" class="max-h-40 overflow-y-auto">
                                <!-- åŠ¨æ€ç”Ÿæˆçš„æœç´¢é€‰é¡¹ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å›¢é˜Ÿæ ‘ -->
                <div id="treeContainer" class="max-h-96 overflow-y-auto">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„æ ‘ç»“æ„ -->
                </div>

                <!-- å›¾ä¾‹ -->
                <div class="flex justify-center gap-6 mt-6 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                        <span>å·¦åŒºå›¢é˜Ÿ</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                        <span>å³åŒºå›¢é˜Ÿ</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                        <span>æ ¹èŠ‚ç‚¹</span>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæˆå‘˜ä¿¡æ¯å’Œæ“ä½œ -->
            <div class="glass-morphism rounded-2xl p-6 fade-in">
                <!-- æˆå‘˜ä¿¡æ¯ -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-user text-blue-600 mr-2"></i>
                        æˆå‘˜ä¿¡æ¯
                    </h3>
                    <div id="memberInfo" class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">æˆå‘˜ID:</span>
                            <span id="infoId" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">å§“å:</span>
                            <span id="infoName" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">çº§åˆ«:</span>
                            <span id="infoLevel" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">æ¨èäºº:</span>
                            <span id="infoParent" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">å®‰ç½®ä½ç½®:</span>
                            <span id="infoPlacement" class="font-medium">-</span>
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ•°æ® -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-blue-600" id="leftTeamCount">0</div>
                        <div class="text-sm text-gray-600">å·¦åŒºäººæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-red-600" id="rightTeamCount">0</div>
                        <div class="text-sm text-gray-600">å³åŒºäººæ•°</div>
                    </div>
                </div>

                <!-- æˆå‘˜ç®¡ç†è¡¨å• -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-cog text-blue-600 mr-2"></i>
                        æˆå‘˜ç®¡ç†
                    </h3>
                    <form id="memberForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å§“å *</label>
                            <input type="text" id="memberName" class="form-input" placeholder="è¯·è¾“å…¥å§“å" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">çº§åˆ«</label>
                            <select id="memberLevel" class="form-input">
                                <option value="ä¼šå‘˜">ä¼šå‘˜</option>
                                <option value="ä¸­çº§ä¼šå‘˜">ä¸­çº§ä¼šå‘˜</option>
                                <option value="é«˜çº§ä¼šå‘˜">é«˜çº§ä¼šå‘˜</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨èäºº</label>
                            <div class="relative">
                                <input type="text" id="parentSearch" class="form-input pr-10" 
                                       placeholder="æœç´¢æ¨èäººå§“å..." 
                                       oninput="searchParent(this.value)"
                                       onfocus="showParentDropdown()"
                                       onblur="hideParentDropdown()">
                                <button type="button" onclick="toggleParentDropdown()" 
                                        class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="parentDropdown" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto z-50 hidden">
                                    <div class="p-2">
                                        <input type="text" class="w-full p-2 border rounded" 
                                               placeholder="æœç´¢..." 
                                               oninput="filterParentOptions(this.value)">
                                    </div>
                                    <div id="parentOptions" class="max-h-32 overflow-y-auto">
                                        <!-- åŠ¨æ€ç”Ÿæˆçš„æ¨èäººé€‰é¡¹ -->
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="selectedParentId" value="">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å®‰ç½®ä½ç½®</label>
                            <div class="flex gap-4">
                                <label class="flex items-center">
                                    <input type="radio" name="placement" value="left" checked class="mr-2">
                                    <span>å·¦åŒº</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="placement" value="right" class="mr-2">
                                    <span>å³åŒº</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="placement" value="auto" class="mr-2">
                                    <span>è‡ªåŠ¨å¹³è¡¡</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button type="submit" class="btn-primary flex-1">
                                <i class="fas fa-plus mr-2"></i>æ·»åŠ 
                            </button>
                            <button type="button" onclick="editMember()" class="btn-secondary flex-1">
                                <i class="fas fa-edit mr-2"></i>ç¼–è¾‘
                            </button>
                            <button type="button" onclick="deleteMember()" class="btn-danger flex-1">
                                <i class="fas fa-trash mr-2"></i>åˆ é™¤
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åˆ†æ -->
        <div class="glass-morphism rounded-2xl p-6 mt-6 fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                æ•°æ®åˆ†æ
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="stat-card">
                    <div class="text-3xl font-bold text-green-600" id="totalMembers">0</div>
                    <div class="text-sm text-gray-600">æ€»æˆå‘˜æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-purple-600" id="totalSenior">0</div>
                    <div class="text-sm text-gray-600">é«˜çº§ä¼šå‘˜</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-orange-600" id="totalIntermediate">0</div>
                    <div class="text-sm text-gray-600">ä¸­çº§ä¼šå‘˜</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-teal-600" id="totalBasic">0</div>
                    <div class="text-sm text-gray-600">ä¼šå‘˜</div>
                </div>
                <div class="stat-card">
                    <div class="text-3xl font-bold text-teal-600" id="maxDepth">0</div>
                    <div class="text-sm text-gray-600">æœ€å¤§å±‚çº§</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨çŠ¶æ€æ  -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 glass-morphism">
        <div class="max-w-7xl mx-auto flex justify-between items-center text-sm">
            <div class="flex items-center gap-4">
                <span id="saveStatus" class="text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="statusText">å°±ç»ª</span>
                </span>
                <span id="lastSaveTime" class="text-gray-500">
                    ä¸Šæ¬¡ä¿å­˜: <span id="saveTimeDisplay">æœªä¿å­˜</span>
                </span>
            </div>
            <div class="flex gap-2">
                <button onclick="clearLocalData()" class="text-red-600 hover:text-red-800 text-sm">
                    <i class="fas fa-trash mr-1"></i>æ¸…é™¤æœ¬åœ°æ•°æ®
                </button>
            </div>
        </div>
    </div>

    <!-- æˆå‘˜è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">
                    <i class="fas fa-user-circle text-blue-600 mr-2"></i>
                    æˆå‘˜è¯¦ç»†ä¿¡æ¯
                </h3>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="detailContent" class="space-y-4">
                <!-- åŠ¨æ€ç”Ÿæˆçš„è¯¦ç»†å†…å®¹ -->
            </div>
            
            <div class="flex gap-2 pt-4">
                <button onclick="selectDetailMember()" class="btn-primary flex-1">
                    <i class="fas fa-mouse-pointer mr-2"></i>é€‰ä¸­
                </button>
                <button onclick="closeDetailModal()" class="btn-secondary flex-1">
                    <i class="fas fa-times mr-2"></i>å…³é—­
                </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æˆå‘˜æ¨¡æ€æ¡† -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 max-h-screen overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-user-edit text-blue-600 mr-2"></i>
                ç¼–è¾‘æˆå‘˜ä¿¡æ¯
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å§“å *</label>
                    <input type="text" id="editName" class="form-input" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¼šå‘˜çº§åˆ«</label>
                    <select id="editLevel" class="form-input">
                        <option value="ä¼šå‘˜">ä¼šå‘˜</option>
                        <option value="ä¸­çº§ä¼šå‘˜">ä¸­çº§ä¼šå‘˜</option>
                        <option value="é«˜çº§ä¼šå‘˜">é«˜çº§ä¼šå‘˜</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨èäºº</label>
                    <div class="relative">
                        <input type="text" id="editParentSearch" class="form-input pr-10" 
                               placeholder="æœç´¢æ¨èäºº..." 
                               oninput="searchEditParent(this.value)">
                        <input type="hidden" id="editSelectedParentId" value="">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å®‰ç½®ä½ç½®</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="editPlacement" value="left" class="mr-2">
                            <span>å·¦åŒº</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="editPlacement" value="right" class="mr-2">
                            <span>å³åŒº</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="saveEditMember()" class="btn-primary flex-1">
                        <i class="fas fa-save mr-2"></i>ä¿å­˜
                    </button>
                    <button onclick="closeEditModal()" class="btn-secondary flex-1">
                        <i class="fas fa-times mr-2"></i>å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileImport(event)">

    <script>
        // å…¨å±€æ•°æ®
        let teamData = {
            id: "1000",
            name: "å¼ ä¸‰",
            level: "é«˜çº§ä¼šå‘˜",
            leftTeamSize: 2,
            rightTeamSize: 2,
            parentId: null,
            placement: "root",
            children: [
                {
                    id: "1001",
                    name: "æå››",
                    level: "ä¸­çº§ä¼šå‘˜",
                    leftTeamSize: 1,
                    rightTeamSize: 0,
                    parentId: "1000",
                    placement: "left",
                    children: [
                        {
                            id: "1003",
                            name: "ç‹äº”",
                            level: "ä¼šå‘˜",
                            leftTeamSize: 0,
                            rightTeamSize: 0,
                            parentId: "1001",
                            placement: "left",
                            children: []
                        }
                    ]
                },
                {
                    id: "1002",
                    name: "èµµå…­",
                    level: "ä¸­çº§ä¼šå‘˜",
                    leftTeamSize: 0,
                    rightTeamSize: 1,
                    parentId: "1000",
                    placement: "right",
                    children: [
                        {
                            id: "1004",
                            name: "å­™ä¸ƒ",
                            level: "ä¼šå‘˜",
                            leftTeamSize: 0,
                            rightTeamSize: 1,
                            parentId: "1002",
                            placement: "right",
                            children: [
                                {
                                    id: "1005",
                                    name: "é¾šæ¶›",
                                    level: "ä¸­çº§ä¼šå‘˜",
                                    leftTeamSize: 0,
                                    rightTeamSize: 0,
                                    parentId: "1004",
                                    placement: "right",
                                    children: []
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        let selectedNode = null;
        let allMembers = [];
        let expandedNodes = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            loadFromLocal(true);
            
            renderTree();
            collectAllMembers();
            updateParentSelect();
            updateStatistics();
            selectNode(teamData);
            
            // åˆå§‹åŒ–å±•å¼€çŠ¶æ€
            initializeExpandedNodes();
            
            // æ·»åŠ è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
            setInterval(autoSave, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
        });

        // æ”¶é›†æ‰€æœ‰æˆå‘˜
        function collectAllMembers() {
            allMembers = [];
            function traverse(node) {
                allMembers.push({
                    id: node.id,
                    name: node.name,
                    level: node.level
                });
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => traverse(child));
                }
            }
            traverse(teamData);
        }

        // æ¸²æŸ“æ ‘ç»“æ„
        function renderTree(filterText = '') {
            const container = document.getElementById('treeContainer');
            const html = renderNode(teamData, 0, filterText);
            container.innerHTML = html;
        }

        // é€’å½’æ¸²æŸ“èŠ‚ç‚¹
        function renderNode(node, level, filterText) {
            const isExpanded = expandedNodes[node.id] === true;
            const isMatch = filterText && (
                node.name.toLowerCase().includes(filterText.toLowerCase()) ||
                node.id.includes(filterText)
            );
            
            let html = `
                <div class="tree-node ${node.placement} ${selectedNode?.id === node.id ? 'selected' : ''} ${isMatch ? 'ring-2 ring-yellow-400' : ''}" 
                     onclick="selectNode(${JSON.stringify(node).replace(/"/g, '&quot;')})" 
                     style="margin-left: ${level * 20}px;">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-bold">${node.name}</div>
                            <div class="text-sm opacity-75">ID: ${node.id} | ${node.level}</div>
                            <div class="text-xs opacity-60">å·¦åŒº: ${node.leftTeamSize}äºº | å³åŒº: ${node.rightTeamSize}äºº</div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${isMatch ? `
                                <button onclick="event.stopPropagation(); showMemberDetail('${node.id}')" 
                                        class="text-sm px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                                    <i class="fas fa-info-circle"></i> è¯¦æƒ…
                                </button>
                            ` : ''}
                            ${node.children && node.children.length > 0 ? `
                                <button onclick="event.stopPropagation(); toggleNode('${node.id}')" class="text-sm px-2 py-1 bg-gray-200 rounded">
                                    ${isExpanded ? '<i class="fas fa-chevron-down"></i>' : '<i class="fas fa-chevron-right"></i>'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            if (node.children && node.children.length > 0 && isExpanded) {
                html += '<div class="tree-children">';
                node.children.forEach(child => {
                    html += renderNode(child, level + 1, filterText);
                });
                html += '</div>';
            }
            
            return html;
        }

        // åˆ‡æ¢èŠ‚ç‚¹å±•å¼€/æŠ˜å 
        function toggleNode(nodeId) {
            expandedNodes[nodeId] = !expandedNodes[nodeId];
            renderTree();
        }

        // å±•å¼€å…¨éƒ¨
        function expandAll() {
            function setExpanded(node) {
                expandedNodes[node.id] = true;
                if (node.children) {
                    node.children.forEach(setExpanded);
                }
            }
            setExpanded(teamData);
            renderTree();
        }

        // æŠ˜å å…¨éƒ¨
        function collapseAll() {
            function setCollapsed(node) {
                expandedNodes[node.id] = false;
                if (node.children) {
                    node.children.forEach(setCollapsed);
                }
            }
            setCollapsed(teamData);
            renderTree();
        }

        // æ¸…ç©ºæœç´¢
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            renderTree('');
            showNotification('æœç´¢å·²æ¸…ç©º', 'info');
        }

        // é‡ç½®è§†å›¾
        function resetView() {
            expandedNodes = {};
            selectedNode = null;
            document.getElementById('searchInput').value = '';
            renderTree();
            selectNode(teamData);
        }

        // åˆå§‹åŒ–å±•å¼€çŠ¶æ€
        function initializeExpandedNodes() {
            // åªå±•å¼€å‰ä¸¤å±‚ï¼Œé¿å…ç•Œé¢è¿‡äºå¤æ‚
            function initExpand(node, level = 0) {
                expandedNodes[node.id] = level < 2; // åªå±•å¼€å‰ä¸¤å±‚
                if (node.children) {
                    node.children.forEach(child => initExpand(child, level + 1));
                }
            }
            initExpand(teamData);
        }

        // å¤„ç†æœç´¢è¾“å…¥
        function handleSearchInput(searchText) {
            // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ¸…ç©ºä¸‹æ‹‰æ¡†
            if (!searchText || searchText.trim() === '') {
                document.getElementById('searchDropdown').classList.add('hidden');
                renderTree('');
                return;
            }
            
            // æ˜¾ç¤ºä¸‹æ‹‰æ¡†å¹¶è¿‡æ»¤é€‰é¡¹
            showSearchDropdown();
            filterSearchOptions(searchText);
        }

        // å¤„ç†å›è½¦é”®
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                executeSearch();
            }
        }

        // æ‰§è¡Œæœç´¢
        function executeSearch() {
            const searchText = document.getElementById('searchInput').value.trim();
            
            console.log('=== å¼€å§‹æœç´¢ ===');
            console.log('æœç´¢æ–‡æœ¬:', searchText);
            console.log('å½“å‰å›¢é˜Ÿæ•°æ®:', JSON.stringify(teamData, null, 2));
            
            if (!searchText) {
                showNotification('è¯·è¾“å…¥æœç´¢å†…å®¹', 'info');
                return;
            }
            
            // éšè—ä¸‹æ‹‰æ¡†
            document.getElementById('searchDropdown').classList.add('hidden');
            
            // æœç´¢æˆå‘˜
            const matchedMember = findMemberBySearch(searchText);
            
            console.log('æœç´¢ç»“æœ:', matchedMember ? matchedMember.name : 'null');
            
            if (matchedMember) {
                console.log('æ‰¾åˆ°æˆå‘˜ï¼Œå¼€å§‹å¤„ç†...');
                
                // è®¾ç½®æœç´¢æ¡†å€¼ä¸ºåŒ¹é…çš„æˆå‘˜åå­—
                document.getElementById('searchInput').value = matchedMember.name;
                
                // å±•å¼€åˆ°è¯¥æˆå‘˜çš„è·¯å¾„
                const expandSuccess = expandToMember(matchedMember.id);
                
                if (expandSuccess) {
                    // ç«‹å³æ¸²æŸ“æ ‘ç»“æ„
                    renderTree('');
                    
                    // çŸ­æš‚å»¶è¿Ÿåé€‰æ‹©å’Œæ»šåŠ¨
                    setTimeout(() => {
                        console.log('å¼€å§‹é€‰æ‹©å’Œæ»šåŠ¨åˆ°æˆå‘˜');
                        selectNode(matchedMember, true); // è·³è¿‡æ¸²æŸ“ï¼Œé¿å…è¦†ç›–è§†è§‰æ•ˆæœ
                        scrollToMember(matchedMember.id);
                        
                        // è·å–å¹¶æ˜¾ç¤ºè¯¦ç»†çš„ä½ç½®ä¿¡æ¯å’Œè¯†åˆ«ç»“æœ
                        const memberPath = getMemberPath(matchedMember.id);
                        showDetailedLocationNotification(matchedMember, memberPath, searchText);
                    }, 50);
                } else {
                    showNotification('æ— æ³•å±•å¼€åˆ°è¯¥æˆå‘˜', 'error');
                }
            } else {
                console.log('æœªæ‰¾åˆ°æˆå‘˜ï¼Œæ˜¾ç¤ºé”™è¯¯é€šçŸ¥');
                // æ˜¾ç¤ºæœªæ‰¾åˆ°çš„è¯¦ç»†æç¤º
                showNotFoundNotification(searchText);
            }
        }

        // æ˜¾ç¤ºæœç´¢ä¸‹æ‹‰æ¡†
        function showSearchDropdown() {
            updateSearchOptions();
            document.getElementById('searchDropdown').classList.remove('hidden');
        }

        // éšè—æœç´¢ä¸‹æ‹‰æ¡†
        function hideSearchDropdown() {
            setTimeout(() => {
                document.getElementById('searchDropdown').classList.add('hidden');
            }, 200);
        }

        // åˆ‡æ¢æœç´¢ä¸‹æ‹‰æ¡†
        function toggleSearchDropdown() {
            const dropdown = document.getElementById('searchDropdown');
            if (dropdown.classList.contains('hidden')) {
                showSearchDropdown();
            } else {
                hideSearchDropdown();
            }
        }

        // æ›´æ–°æœç´¢é€‰é¡¹
        function updateSearchOptions() {
            const searchOptions = document.getElementById('searchOptions');
            searchOptions.innerHTML = '';
            
            allMembers.forEach(member => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 transition-colors';
                optionDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium text-gray-800">${member.name}</div>
                            <div class="text-sm text-gray-600">ID: ${member.id} | ${member.level}</div>
                        </div>
                        <div class="px-2 py-1 text-xs rounded ${
                            member.level === 'é«˜çº§ä¼šå‘˜' ? 'bg-purple-100 text-purple-800' :
                            member.level === 'ä¸­çº§ä¼šå‘˜' ? 'bg-blue-100 text-blue-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${member.level}
                        </div>
                    </div>
                `;
                optionDiv.onclick = () => selectSearchMember(member.id, member.name);
                searchOptions.appendChild(optionDiv);
            });
        }

        // è¿‡æ»¤æœç´¢é€‰é¡¹
        function filterSearchOptions(searchText) {
            const searchOptions = document.getElementById('searchOptions');
            const options = searchOptions.children;
            const lowerSearch = searchText.toLowerCase().trim();
            
            let hasVisibleOptions = false;
            let firstMatchedOption = null;
            
            Array.from(options).forEach(option => {
                const text = option.textContent.toLowerCase();
                const match = text.includes(lowerSearch);
                option.style.display = match ? "block" : "none";
                if (match) {
                    hasVisibleOptions = true;
                    if (!firstMatchedOption) {
                        firstMatchedOption = option;
                        option.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
                    } else {
                        option.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                    }
                } else {
                    option.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
                }
            });
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„é€‰é¡¹ï¼Œæ˜¾ç¤ºæç¤º
            if (!hasVisibleOptions && lowerSearch !== '') {
                searchOptions.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-search mb-2"></i>
                        <div>æœªæ‰¾åˆ°åŒ¹é…çš„æˆå‘˜</div>
                    </div>
                `;
            }
        }

        // é€‰æ‹©æœç´¢æˆå‘˜
        function selectSearchMember(id, name) {
            document.getElementById('searchInput').value = name;
            document.getElementById('searchDropdown').classList.add('hidden');
            
            // æ‰§è¡Œæœç´¢å’Œè·³è½¬
            const member = findNodeById(teamData, id);
            if (member) {
                // å±•å¼€åˆ°è¯¥æˆå‘˜çš„å®Œæ•´è·¯å¾„
                const expandSuccess = expandToMember(member.id);
                
                if (expandSuccess) {
                    // ç«‹å³æ¸²æŸ“æ ‘ç»“æ„
                    renderTree('');
                    
                    // çŸ­æš‚å»¶è¿Ÿåé€‰æ‹©å’Œæ»šåŠ¨
                    setTimeout(() => {
                        selectNode(member, true); // è·³è¿‡æ¸²æŸ“
                        scrollToMember(member.id);
                        
                        // æ˜¾ç¤ºè¯¦ç»†çš„ä½ç½®ä¿¡æ¯
                        const memberPath = getMemberPath(id);
                        showLocationNotification(member, memberPath);
                    }, 50);
                } else {
                    showNotification('æ— æ³•å±•å¼€åˆ°è¯¥æˆå‘˜', 'error');
                }
            }
        }

        // æ˜¾ç¤ºè¯¦ç»†çš„ä½ç½®é€šçŸ¥å’Œè¯†åˆ«ç»“æœ
        function showDetailedLocationNotification(member, path, searchText) {
            // åˆ›å»ºè¯¦ç»†çš„è¯†åˆ«ç»“æœé€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white bg-green-500 fade-in z-50 max-w-md';
            
            // åˆ¤æ–­åŒ¹é…ç±»å‹
            const isExactMatch = member.name.toLowerCase() === searchText.toLowerCase();
            const isIdMatch = member.id === searchText.trim();
            let matchType = 'æ¨¡ç³ŠåŒ¹é…';
            if (isExactMatch) matchType = 'ç²¾ç¡®åŒ¹é…';
            else if (isIdMatch) matchType = 'IDåŒ¹é…';
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-check-circle mr-3 mt-1 text-2xl"></i>
                    <div class="flex-1">
                        <div class="font-bold text-lg mb-2">âœ… æˆåŠŸæ‰¾åˆ°æˆå‘˜</div>
                        <div class="bg-white bg-opacity-20 rounded p-3 mb-2">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">å§“å:</span>
                                <span class="font-bold">${member.name}</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">ID:</span>
                                <span class="font-bold">${member.id}</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">çº§åˆ«:</span>
                                <span class="font-bold">${member.level}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-medium">åŒ¹é…æ–¹å¼:</span>
                                <span class="bg-yellow-400 text-gray-800 px-2 py-1 rounded text-xs font-bold">${matchType}</span>
                            </div>
                        </div>
                        <div class="text-xs">
                            <div class="font-medium mb-1">ğŸ“ å›¢é˜Ÿä½ç½®:</div>
                            <div class="bg-white bg-opacity-20 rounded p-2">${path}</div>
                        </div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="absolute top-2 right-2 text-white opacity-70 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // 6ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 6000);
        }

        // æ˜¾ç¤ºæœªæ‰¾åˆ°é€šçŸ¥
        function showNotFoundNotification(searchText) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white bg-red-500 fade-in z-50 max-w-md';
            
            // è·å–ç°æœ‰æˆå‘˜åˆ—è¡¨
            const memberList = allMembers.map(m => `${m.name}(${m.id})`).slice(0, 8).join(', ');
            const moreText = allMembers.length > 8 ? '...' : '';
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle mr-3 mt-1 text-xl"></i>
                    <div>
                        <div class="font-bold text-lg mb-2">âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æˆå‘˜</div>
                        <div class="bg-white bg-opacity-20 rounded p-3 mb-2">
                            <div class="mb-2">
                                <span class="font-medium">æœç´¢å†…å®¹:</span>
                                <span class="font-bold">"${searchText}"</span>
                            </div>
                            <div>
                                <span class="font-medium">ç°æœ‰æˆå‘˜:</span>
                                <div class="text-xs mt-1 opacity-90">${memberList}${moreText}</div>
                            </div>
                        </div>
                        <div class="text-xs">
                            ğŸ’¡ æç¤ºï¼šè¯·æ£€æŸ¥å§“åæ˜¯å¦æ­£ç¡®ï¼Œæˆ–å°è¯•è¾“å…¥æˆå‘˜ID
                        </div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="absolute top-2 right-2 text-white opacity-70 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // æ˜¾ç¤ºä½ç½®é€šçŸ¥ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
        function showLocationNotification(member, path) {
            // åˆ›å»ºè¯¦ç»†çš„ä½ç½®ä¿¡æ¯é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white bg-blue-500 fade-in z-50 max-w-md';
            notification.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-map-marker-alt mr-3 mt-1 text-xl"></i>
                    <div>
                        <div class="font-bold text-lg mb-1">å·²å®šä½åˆ°: ${member.name}</div>
                        <div class="text-sm opacity-90 mb-2">ID: ${member.id} | çº§åˆ«: ${member.level}</div>
                        <div class="text-xs bg-white bg-opacity-20 rounded p-2">
                            <div class="font-medium mb-1">å›¢é˜Ÿè·¯å¾„:</div>
                            <div class="opacity-90">${path}</div>
                        </div>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="absolute top-2 right-2 text-white opacity-70 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // æœç´¢æˆå‘˜
        function searchMembers(searchText) {
            if (!searchText || searchText.trim() === '') {
                renderTree('');
                return;
            }
            
            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„æˆå‘˜
            const matchedMember = findMemberBySearch(searchText);
            
            if (matchedMember) {
                // å±•å¼€åˆ°è¯¥æˆå‘˜çš„è·¯å¾„
                expandToMember(matchedMember.id);
                // æ¸²æŸ“å®Œæ•´æ ‘
                renderTree('');
                // é«˜äº®å¹¶é€‰ä¸­è¯¥æˆå‘˜
                setTimeout(() => {
                    selectNode(matchedMember);
                    // æ»šåŠ¨åˆ°è¯¥æˆå‘˜ä½ç½®
                    scrollToMember(matchedMember.id);
                    showNotification(`å·²æ‰¾åˆ°: ${matchedMember.name} (${matchedMember.id})`, 'success');
                }, 100);
            } else {
                renderTree(searchText);
                showNotification('æœªæ‰¾åˆ°åŒ¹é…çš„æˆå‘˜', 'error');
            }
        }

        // æ ¹æ®æœç´¢æ¡ä»¶æŸ¥æ‰¾æˆå‘˜
        function findMemberBySearch(searchText) {
            const lowerSearch = searchText.toLowerCase().trim();
            const exactSearch = searchText.trim();
            
            console.log('=== å¼€å§‹æœç´¢æˆå‘˜ ===');
            console.log('æœç´¢æ–‡æœ¬:', searchText);
            console.log('å½“å‰å›¢é˜Ÿæˆå‘˜:', allMembers.map(m => `${m.name}(${m.id})`).join(', '));
            
            let foundMember = null;
            let exactMatches = [];
            let partialMatches = [];
            
            function search(node) {
                console.log('æ£€æŸ¥èŠ‚ç‚¹:', node.name, 'ID:', node.id);
                
                // æ”¶é›†æ‰€æœ‰åŒ¹é…çš„æˆå‘˜
                if (node.name.toLowerCase() === lowerSearch) {
                    console.log('âœ… å®Œå…¨åŒ¹é…:', node.name);
                    exactMatches.push(node);
                } else if (node.name.toLowerCase().includes(lowerSearch)) {
                    console.log('ğŸ”„ éƒ¨åˆ†åŒ¹é…:', node.name);
                    partialMatches.push(node);
                }
                
                if (node.id === exactSearch) {
                    console.log('ğŸ†” IDåŒ¹é…:', node.id);
                    return node; // IDå®Œå…¨åŒ¹é…ç«‹å³è¿”å›
                }
                
                // é€’å½’æœç´¢å­èŠ‚ç‚¹
                if (node.children && node.children.length > 0) {
                    for (let child of node.children) {
                        const found = search(child);
                        if (found) return found;
                    }
                }
                
                return null;
            }
            
            // æœç´¢å›¢é˜Ÿæ•°æ®
            foundMember = search(teamData);
            
            console.log('æœç´¢ç»Ÿè®¡ - å®Œå…¨åŒ¹é…:', exactMatches.length, 'éƒ¨åˆ†åŒ¹é…:', partialMatches.length);
            
            // å¦‚æœæ²¡æœ‰IDåŒ¹é…ï¼Œä¼˜å…ˆè¿”å›å®Œå…¨åŒ¹é…å§“åçš„
            if (!foundMember && exactMatches.length > 0) {
                foundMember = exactMatches[0];
                console.log('ğŸ¯ ä½¿ç”¨å®Œå…¨åŒ¹é…:', foundMember.name);
            }
            
            // æ— è®ºå­—ç¬¦é•¿åº¦å¦‚ä½•ï¼Œåªè¦æœ‰éƒ¨åˆ†åŒ¹é…å°±è¿”å›
            if (!foundMember && partialMatches.length > 0) {
                foundMember = partialMatches[0];
                console.log('ğŸ” ä½¿ç”¨éƒ¨åˆ†åŒ¹é…:', foundMember.name);
            }
            
            console.log('ğŸ“ æœ€ç»ˆè¿”å›:', foundMember ? `${foundMember.name}(${foundMember.id})` : 'null');
            return foundMember;
        }

        // å±•å¼€åˆ°æŒ‡å®šæˆå‘˜çš„è·¯å¾„
        function expandToMember(memberId) {
            console.log('å¼€å§‹å±•å¼€åˆ°æˆå‘˜:', memberId);
            
            // æ”¶é›†ä»æ ¹èŠ‚ç‚¹åˆ°ç›®æ ‡æˆå‘˜çš„è·¯å¾„
            function findPath(node, targetId, currentPath) {
                console.log('æŸ¥æ‰¾è·¯å¾„ - å½“å‰èŠ‚ç‚¹:', node.name, 'ç›®æ ‡ID:', targetId, 'å½“å‰è·¯å¾„:', currentPath);
                
                if (node.id === targetId) {
                    console.log('æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹:', node.name);
                    return [...currentPath, node.id];
                }
                
                if (node.children) {
                    for (let child of node.children) {
                        const foundPath = findPath(child, targetId, [...currentPath, node.id]);
                        if (foundPath) return foundPath;
                    }
                }
                
                return null;
            }
            
            const memberPath = findPath(teamData, memberId);
            
            console.log('æœ€ç»ˆå±•å¼€è·¯å¾„:', memberPath);
            console.log('å½“å‰å±•å¼€çŠ¶æ€:', expandedNodes);
            
            if (memberPath) {
                // å±•å¼€è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹
                memberPath.forEach(nodeId => {
                    expandedNodes[nodeId] = true;
                    console.log('å±•å¼€èŠ‚ç‚¹:', nodeId);
                });
                
                console.log('æ›´æ–°åçš„å±•å¼€çŠ¶æ€:', expandedNodes);
                console.log('å±•å¼€çš„èŠ‚ç‚¹è·¯å¾„:', memberPath);
                
                // ä¸åœ¨è¿™é‡Œæ¸²æŸ“ï¼Œè®©è°ƒç”¨è€…æ§åˆ¶æ¸²æŸ“æ—¶æœº
                console.log('è·¯å¾„å±•å¼€å®Œæˆï¼Œç­‰å¾…æ¸²æŸ“');
                return true;
            } else {
                console.log('æœªæ‰¾åˆ°è·¯å¾„åˆ°æˆå‘˜:', memberId);
                return false;
            }
        }

        // æ»šåŠ¨åˆ°æŒ‡å®šæˆå‘˜
        function scrollToMember(memberId) {
            // æŸ¥æ‰¾DOMå…ƒç´ 
            const allNodes = document.querySelectorAll('.tree-node');
            
            for (let nodeElement of allNodes) {
                const onclickAttr = nodeElement.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(memberId)) {
                    // æ»šåŠ¨åˆ°è¯¥å…ƒç´ 
                    nodeElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    // æ·»åŠ æ›´å¼ºçš„è§†è§‰æ ‡è¯†æ•ˆæœ
                    nodeElement.classList.add('ring-4', 'ring-yellow-400', 'ring-offset-2', 'scale-105', 'shadow-xl');
                    
                    // æ·»åŠ ä½ç½®æŒ‡ç¤ºå™¨
                    const indicator = document.createElement('div');
                    indicator.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xs font-bold z-10 animate-pulse';
                    indicator.innerHTML = '<i class="fas fa-map-pin"></i>';
                    nodeElement.style.position = 'relative';
                    nodeElement.appendChild(indicator);
                    
                    // 3ç§’åç§»é™¤æ•ˆæœ
                    setTimeout(() => {
                        nodeElement.classList.remove('ring-4', 'ring-yellow-400', 'ring-offset-2', 'scale-105', 'shadow-xl');
                        if (indicator.parentElement) {
                            indicator.parentElement.removeChild(indicator);
                        }
                    }, 3000);
                    
                    break;
                }
            }
        }

        // é€‰æ‹©èŠ‚ç‚¹
        function selectNode(node, skipRender = false) {
            selectedNode = node;
            updateMemberInfo(node);
            if (!skipRender) {
                renderTree('');
            }
            updateParentSelect();
        }

        // æ›´æ–°æˆå‘˜ä¿¡æ¯
        function updateMemberInfo(member) {
            document.getElementById("infoId").textContent = member.id;
            document.getElementById("infoName").textContent = member.name;
            document.getElementById("infoLevel").textContent = member.level;
            document.getElementById("infoParent").textContent = member.parentId || "æ— ";
            document.getElementById("infoPlacement").textContent = 
                member.placement === "left" ? "å·¦åŒº" : 
                member.placement === "right" ? "å³åŒº" : "æ ¹èŠ‚ç‚¹";
            
            document.getElementById("leftTeamCount").textContent = member.leftTeamSize;
            document.getElementById("rightTeamCount").textContent = member.rightTeamSize;
        }

        // æ›´æ–°æ¨èäººé€‰æ‹©
        function updateParentSelect() {
            updateParentOptions();
            
            // åªæœ‰å½“æœ‰é€‰ä¸­çš„èŠ‚ç‚¹ä¸”ä¸æ˜¯åœ¨æ·»åŠ æ–°æˆå‘˜æ—¶æ‰æ›´æ–°æ¨èäºº
            if (selectedNode && document.getElementById("memberForm").style.display !== 'none') {
                console.log('æ›´æ–°æ¨èäººé€‰æ‹©æ¡†ä¸ºå½“å‰é€‰ä¸­èŠ‚ç‚¹:', selectedNode.name);
                document.getElementById("selectedParentId").value = selectedNode.id;
                document.getElementById("parentSearch").value = selectedNode.name;
            }
        }

        // æ›´æ–°æ¨èäººé€‰é¡¹
        function updateParentOptions() {
            const parentOptions = document.getElementById("parentOptions");
            parentOptions.innerHTML = '';
            
            allMembers.forEach(member => {
                const optionDiv = document.createElement("div");
                optionDiv.className = "p-2 hover:bg-gray-100 cursor-pointer border-b";
                optionDiv.innerHTML = `
                    <div class="font-medium">${member.name}</div>
                    <div class="text-sm text-gray-600">ID: ${member.id} | ${member.level}</div>
                `;
                optionDiv.onclick = () => selectParent(member.id, member.name);
                parentOptions.appendChild(optionDiv);
            });
        }

        // æ˜¾ç¤ºæ¨èäººä¸‹æ‹‰æ¡†
        function showParentDropdown() {
            document.getElementById("parentDropdown").classList.remove("hidden");
            updateParentOptions();
        }

        // éšè—æ¨èäººä¸‹æ‹‰æ¡†
        function hideParentDropdown() {
            setTimeout(() => {
                document.getElementById("parentDropdown").classList.add("hidden");
            }, 200);
        }

        // åˆ‡æ¢æ¨èäººä¸‹æ‹‰æ¡†
        function toggleParentDropdown() {
            const dropdown = document.getElementById("parentDropdown");
            if (dropdown.classList.contains("hidden")) {
                showParentDropdown();
            } else {
                hideParentDropdown();
            }
        }

        // æœç´¢æ¨èäºº
        function searchParent(searchText) {
            showParentDropdown();
            filterParentOptions(searchText);
        }

        // è¿‡æ»¤æ¨èäººé€‰é¡¹
        function filterParentOptions(searchText) {
            const parentOptions = document.getElementById("parentOptions");
            const options = parentOptions.children;
            
            Array.from(options).forEach(option => {
                const text = option.textContent.toLowerCase();
                const match = text.includes(searchText.toLowerCase());
                option.style.display = match ? "block" : "none";
            });
        }

        // é€‰æ‹©æ¨èäºº
        function selectParent(id, name) {
            document.getElementById("selectedParentId").value = id;
            document.getElementById("parentSearch").value = name;
            hideParentDropdown();
        }

        // æœç´¢ç¼–è¾‘æ¨èäºº
        function searchEditParent(searchText) {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æœç´¢é€»è¾‘
            const allParents = allMembers.filter(m => m.id !== selectedNode?.id);
            const filtered = allParents.filter(m => 
                m.name.toLowerCase().includes(searchText.toLowerCase()) ||
                m.id.includes(searchText)
            );
            
            if (filtered.length === 1) {
                document.getElementById("editSelectedParentId").value = filtered[0].id;
            }
        }

        // æŸ¥æ‰¾èŠ‚ç‚¹
        function findNodeById(node, id) {
            if (node.id === id) return node;
            
            if (node.children) {
                for (let child of node.children) {
                    const found = findNodeById(child, id);
                    if (found) return found;
                }
            }
            
            return null;
        }

        // æ·»åŠ æˆå‘˜
        document.getElementById("memberForm").addEventListener("submit", function(e) {
            e.preventDefault();
            
            const name = document.getElementById("memberName").value.trim();
            const level = document.getElementById("memberLevel").value;
            const placement = document.querySelector('input[name="placement"]:checked').value;
            
            if (!name) {
                showNotification('è¯·è¾“å…¥æˆå‘˜å§“å', 'error');
                return;
            }
            
            const parentId = document.getElementById("selectedParentId").value;
            if (!parentId) {
                showNotification('è¯·é€‰æ‹©æ¨èäºº', 'error');
                return;
            }
            
            const parentNode = findNodeById(teamData, parentId);
            if (!parentNode) {
                showNotification('æœªæ‰¾åˆ°æ¨èäºº', 'error');
                return;
            }
            
            // ç”Ÿæˆæ–°ID
            let newId = "1001";
            if (allMembers.length > 0) {
                const maxId = Math.max(...allMembers.map(m => parseInt(m.id)));
                newId = String(maxId + 1);
            }
            
            // å¤„ç†è‡ªåŠ¨å¹³è¡¡
            let finalPlacement = placement;
            if (placement === "auto") {
                finalPlacement = parentNode.leftTeamSize <= parentNode.rightTeamSize ? "left" : "right";
            }
            
            const newMember = {
                id: newId,
                name: name,
                level: level,
                leftTeamSize: 0,
                rightTeamSize: 0,
                parentId: parentId,
                placement: finalPlacement,
                children: []
            };
            
            if (!parentNode.children) parentNode.children = [];
            parentNode.children.push(newMember);
            
            // æ›´æ–°çˆ¶èŠ‚ç‚¹ç»Ÿè®¡
            if (finalPlacement === "left") {
                parentNode.leftTeamSize++;
            } else if (finalPlacement === "right") {
                parentNode.rightTeamSize++;
            }
            
            // é‡æ–°æ¸²æŸ“
            collectAllMembers();
            renderTree();
            updateStatistics();
            
            // é€‰ä¸­æ–°æˆå‘˜
            setTimeout(() => {
                selectNode(newMember);
            }, 100);
            
            showNotification(`æˆå‘˜ ${name} æ·»åŠ æˆåŠŸï¼`, 'success');
            
            // é‡ç½®è¡¨å•ä½†ä¸æ¸…ç©ºæ¨èäººä¿¡æ¯ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åˆšæ‰çš„é€‰æ‹©
            document.getElementById("memberName").value = "";
            document.getElementById("memberLevel").value = "ä¼šå‘˜";
            document.querySelector('input[name="placement"][value="left"]').checked = true;
            
            console.log(`âœ… æˆå‘˜ ${name} å·²æ·»åŠ åˆ°æ¨èäºº ${parentNode.name} (${parentId}) ä¸‹é¢`);
            console.log('æ·»åŠ åçš„çˆ¶èŠ‚ç‚¹çŠ¶æ€:', {
                name: parentNode.name,
                id: parentNode.id,
                leftTeamSize: parentNode.leftTeamSize,
                rightTeamSize: parentNode.rightTeamSize,
                childrenCount: parentNode.children ? parentNode.children.length : 0
            });
            
            // ç¡®ä¿æ¨èäººä¸ä¼šè¢«åç»­æ“ä½œè¦†ç›–
            setTimeout(() => {
                console.log('ğŸ”’ é”å®šæ¨èäººé€‰æ‹©æ¡†ï¼Œé˜²æ­¢è¢«æ„å¤–è¦†ç›–');
                const selectedParentId = document.getElementById("selectedParentId");
                const parentSearch = document.getElementById("parentSearch");
                if (selectedParentId.value !== parentId) {
                    console.warn('âš ï¸ æ¨èäººIDè¢«æ„å¤–æ”¹å˜ï¼Œæ¢å¤ä¸­...');
                    selectedParentId.value = parentId;
                    parentSearch.value = parentNode.name;
                }
            }, 500);
        });

        // ç¼–è¾‘æˆå‘˜
        function editMember() {
            if (!selectedNode) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæˆå‘˜è¿›è¡Œç¼–è¾‘', 'error');
                return;
            }
            
            if (selectedNode.id === "1000") {
                showNotification("æ ¹èŠ‚ç‚¹ä¸èƒ½ç¼–è¾‘æ¨èäººå’Œå®‰ç½®ä½ç½®ï¼", 'error');
                return;
            }
            
            openEditModal();
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal() {
            if (!selectedNode) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæˆå‘˜è¿›è¡Œç¼–è¾‘', 'error');
                return;
            }
            
            // å¡«å……å½“å‰æ•°æ®
            document.getElementById("editName").value = selectedNode.name;
            document.getElementById("editLevel").value = selectedNode.level;
            document.getElementById("editSelectedParentId").value = selectedNode.parentId || "";
            
            // æŸ¥æ‰¾å¹¶æ˜¾ç¤ºæ¨èäººå§“å
            if (selectedNode.parentId) {
                const parent = findNodeById(teamData, selectedNode.parentId);
                if (parent) {
                    document.getElementById("editParentSearch").value = parent.name;
                }
            }
            
            // è®¾ç½®å®‰ç½®ä½ç½®
            const placementRadios = document.querySelectorAll('input[name="editPlacement"]');
            placementRadios.forEach(radio => {
                radio.checked = radio.value === selectedNode.placement;
            });
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById("editModal").classList.remove("hidden");
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById("editModal").classList.add("hidden");
        }

        // ä¿å­˜ç¼–è¾‘çš„æˆå‘˜
        function saveEditMember() {
            if (!selectedNode) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„æˆå‘˜', 'error');
                return;
            }
            
            const newName = document.getElementById("editName").value.trim();
            const newLevel = document.getElementById("editLevel").value;
            const newParentId = document.getElementById("editSelectedParentId").value;
            const newPlacement = document.querySelector('input[name="editPlacement"]:checked')?.value;
            
            console.log('=== å¼€å§‹ä¿å­˜ç¼–è¾‘ ===');
            console.log('åŸæˆå‘˜ä¿¡æ¯:', {
                name: selectedNode.name,
                level: selectedNode.level,
                parentId: selectedNode.parentId,
                placement: selectedNode.placement
            });
            console.log('æ–°æˆå‘˜ä¿¡æ¯:', {
                name: newName,
                level: newLevel,
                parentId: newParentId,
                placement: newPlacement
            });
            
            if (!newName) {
                showNotification('è¯·è¾“å…¥æˆå‘˜å§“å', 'error');
                return;
            }
            
            // æ£€æŸ¥æ¨èäººæ˜¯å¦æ˜¯è‡ªå·±çš„ä¸‹çº§
            if (newParentId && isDescendant(selectedNode.id, newParentId)) {
                showNotification('æ¨èäººä¸èƒ½æ˜¯è‡ªå·±çš„ä¸‹çº§æˆå‘˜ï¼', 'error');
                return;
            }
            
            // è·å–åŸçˆ¶èŠ‚ç‚¹
            const oldParentId = selectedNode.parentId;
            const oldPlacement = selectedNode.placement;
            
            // æ›´æ–°æˆå‘˜åŸºæœ¬ä¿¡æ¯ï¼ˆåç§°å’Œçº§åˆ«ï¼‰
            const oldLevel = selectedNode.level;
            selectedNode.name = newName;
            selectedNode.level = newLevel;
            
            console.log('çº§åˆ«æ›´æ–°:', {
                oldLevel: oldLevel,
                newLevel: newLevel,
                updateSuccess: selectedNode.level === newLevel
            });
            
            // å¤„ç†æ¨èäººå’Œä½ç½®çš„å˜åŒ–
            if (newParentId && newParentId !== oldParentId) {
                console.log('æ¨èäººå‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°ç»„ç»‡æ ‘ç»“æ„');
                
                // ä»æ—§çˆ¶èŠ‚ç‚¹ç§»é™¤
                if (oldParentId) {
                    const oldParent = findNodeById(teamData, oldParentId);
                    if (oldParent && oldParent.children) {
                        const index = oldParent.children.findIndex(child => child.id === selectedNode.id);
                        if (index > -1) {
                            oldParent.children.splice(index, 1);
                            if (oldPlacement === "left") {
                                oldParent.leftTeamSize--;
                            } else if (oldPlacement === "right") {
                                oldParent.rightTeamSize--;
                            }
                            console.log(`ä»åŸæ¨èäºº ${oldParent.name} ä¸‹ç§»é™¤`);
                        }
                    }
                }
                
                // æ·»åŠ åˆ°æ–°çˆ¶èŠ‚ç‚¹
                const newParent = findNodeById(teamData, newParentId);
                if (newParent) {
                    selectedNode.parentId = newParentId;
                    selectedNode.placement = newPlacement;
                    if (!newParent.children) newParent.children = [];
                    newParent.children.push(selectedNode);
                    
                    if (newPlacement === "left") {
                        newParent.leftTeamSize++;
                    } else if (newPlacement === "right") {
                        newParent.rightTeamSize++;
                    }
                    console.log(`æ·»åŠ åˆ°æ–°æ¨èäºº ${newParent.name} çš„${newPlacement === 'left' ? 'å·¦åŒº' : 'å³åŒº'}`);
                }
            } else {
                // æ¨èäººæ²¡æœ‰å˜åŒ–ï¼Œåªéœ€è¦æ›´æ–°å®‰ç½®ä½ç½®
                if (newPlacement !== oldPlacement) {
                    selectedNode.placement = newPlacement;
                    
                    // æ›´æ–°åŸçˆ¶èŠ‚ç‚¹çš„ç»Ÿè®¡
                    if (oldParentId) {
                        const oldParent = findNodeById(teamData, oldParentId);
                        if (oldParent) {
                            // å…ˆå‡å»æ—§ä½ç½®
                            if (oldPlacement === "left") {
                                oldParent.leftTeamSize--;
                            } else if (oldPlacement === "right") {
                                oldParent.rightTeamSize--;
                            }
                            
                            // åŠ ä¸Šæ–°ä½ç½®
                            if (newPlacement === "left") {
                                oldParent.leftTeamSize++;
                            } else if (newPlacement === "right") {
                                oldParent.rightTeamSize++;
                            }
                            console.log(`æ›´æ–°å®‰ç½®ä½ç½®ä» ${oldPlacement} åˆ° ${newPlacement}`);
                        }
                    }
                } else {
                    console.log('æ¨èäººå’Œå®‰ç½®ä½ç½®éƒ½æ²¡æœ‰å˜åŒ–');
                }
            }
            
            console.log('ä¿å­˜åçš„æˆå‘˜ä¿¡æ¯:', {
                name: selectedNode.name,
                level: selectedNode.level,
                parentId: selectedNode.parentId,
                placement: selectedNode.placement
            });
            
            // é‡æ–°æ¸²æŸ“
            collectAllMembers();
            renderTree();
            
            console.log('é‡æ–°æ¸²æŸ“åéªŒè¯çº§åˆ«:', {
                selectedNodeId: selectedNode.id,
                currentLevel: selectedNode.level,
                expectedLevel: newLevel,
                isCorrect: selectedNode.level === newLevel
            });
            
            // åœ¨å…³é—­æ¨¡æ€æ¡†ä¹‹å‰æ›´æ–°ä¿¡æ¯ï¼Œç¡®ä¿é€‰ä¸­èŠ‚ç‚¹æ²¡æœ‰è¢«é‡ç½®
            updateMemberInfo(selectedNode);
            updateStatistics();
            closeEditModal();
            
            // å…³é—­æ¨¡æ€æ¡†åå†æ›´æ–°æ¨èäººé€‰æ‹©ï¼Œé¿å…å¹²æ‰°
            updateParentSelect();
            
            showNotification("æˆå‘˜ä¿¡æ¯æ›´æ–°æˆåŠŸï¼", 'success');
            
            // è‡ªåŠ¨ä¿å­˜
            setTimeout(autoSave, 1000);
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯åä»£èŠ‚ç‚¹
        function isDescendant(ancestorId, nodeId) {
            function check(node) {
                if (node.id === nodeId) return true;
                if (node.children) {
                    return node.children.some(child => check(child));
                }
                return false;
            }
            
            const ancestor = findNodeById(teamData, ancestorId);
            return ancestor ? check(ancestor) : false;
        }

        // åˆ é™¤æˆå‘˜
        function deleteMember() {
            if (!selectedNode) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæˆå‘˜', 'error');
                return;
            }
            
            if (selectedNode.id === "1000") {
                showNotification("ä¸èƒ½åˆ é™¤æ ¹èŠ‚ç‚¹æˆå‘˜ï¼", 'error');
                return;
            }
            
            if (selectedNode.children && selectedNode.children.length > 0) {
                showNotification("è¯¥æˆå‘˜ä¸‹æœ‰å›¢é˜Ÿï¼Œä¸èƒ½åˆ é™¤ï¼", 'error');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤æˆå‘˜ ${selectedNode.name} å—ï¼Ÿ`)) {
                const parentId = selectedNode.parentId;
                const parentNode = findNodeById(teamData, parentId);
                
                if (parentNode && parentNode.children) {
                    const index = parentNode.children.findIndex(child => child.id === selectedNode.id);
                    if (index > -1) {
                        // æ›´æ–°çˆ¶èŠ‚ç‚¹ç»Ÿè®¡
                        if (selectedNode.placement === "left") {
                            parentNode.leftTeamSize--;
                        } else if (selectedNode.placement === "right") {
                            parentNode.rightTeamSize--;
                        }
                        
                        parentNode.children.splice(index, 1);
                        selectedNode = null;
                        collectAllMembers();
                        renderTree();
                        updateStatistics();
                        selectNode(teamData);
                        showNotification("æˆå‘˜åˆ é™¤æˆåŠŸï¼", 'success');
                        
                        // è‡ªåŠ¨ä¿å­˜
                        setTimeout(autoSave, 1000);
                    }
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStatistics() {
            let totalMembers = 0;
            let totalSenior = 0;
            let totalIntermediate = 0;
            let totalBasic = 0;
            let maxDepth = 0;
            
            function analyze(node, depth = 0) {
                totalMembers++;
                
                if (node.level === 'é«˜çº§ä¼šå‘˜') {
                    totalSenior++;
                } else if (node.level === 'ä¸­çº§ä¼šå‘˜') {
                    totalIntermediate++;
                } else if (node.level === 'ä¼šå‘˜') {
                    totalBasic++;
                }
                
                maxDepth = Math.max(maxDepth, depth);
                
                if (node.children) {
                    node.children.forEach(child => analyze(child, depth + 1));
                }
            }
            
            analyze(teamData);
            
            document.getElementById("totalMembers").textContent = totalMembers;
            document.getElementById("totalSenior").textContent = totalSenior;
            document.getElementById("totalIntermediate").textContent = totalIntermediate;
            document.getElementById("totalBasic").textContent = totalBasic;
            document.getElementById("maxDepth").textContent = maxDepth;
        }

        // å¯¼å‡ºæ•°æ®ä¸ºExcel
        function exportData() {
            try {
                // å‡†å¤‡Excelæ•°æ®
                const excelData = [];
                
                // é€’å½’æ”¶é›†æ‰€æœ‰æˆå‘˜æ•°æ®
                function collectMemberData(node, level = 0, path = '') {
                    const memberPath = path ? `${path} -> ${node.name}` : node.name;
                    
                    excelData.push({
                        'æˆå‘˜ID': node.id,
                        'å§“å': node.name,
                        'çº§åˆ«': node.level,
                        'æ¨èäººID': node.parentId || '',
                        'å®‰ç½®ä½ç½®': node.placement === 'left' ? 'å·¦åŒº' : node.placement === 'right' ? 'å³åŒº' : 'æ ¹èŠ‚ç‚¹',
                        'å·¦åŒºå›¢é˜Ÿäººæ•°': node.leftTeamSize,
                        'å³åŒºå›¢é˜Ÿäººæ•°': node.rightTeamSize,
                        'å›¢é˜Ÿæ€»äººæ•°': node.leftTeamSize + node.rightTeamSize,
                        'å±‚çº§': level,
                        'è·¯å¾„': memberPath
                    });
                    
                    if (node.children && node.children.length > 0) {
                        node.children.forEach(child => {
                            collectMemberData(child, level + 1, memberPath);
                        });
                    }
                }
                
                collectMemberData(teamData);
                
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // è®¾ç½®åˆ—å®½
                const colWidths = [
                    {wch: 10}, // æˆå‘˜ID
                    {wch: 15}, // å§“å
                    {wch: 10}, // çº§åˆ«
                    {wch: 12}, // æ¨èäººID
                    {wch: 12}, // å®‰ç½®ä½ç½®
                    {wch: 12}, // å·¦åŒºå›¢é˜Ÿäººæ•°
                    {wch: 12}, // å³åŒºå›¢é˜Ÿäººæ•°
                    {wch: 12}, // å›¢é˜Ÿæ€»äººæ•°
                    {wch: 8},  // å±‚çº§
                    {wch: 30}  // è·¯å¾„
                ];
                ws['!cols'] = colWidths;
                
                // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(wb, ws, "å›¢é˜Ÿæˆå‘˜");
                
                // åˆ›å»ºç»Ÿè®¡ä¿¡æ¯å·¥ä½œè¡¨
                const statsData = [
                    {'ç»Ÿè®¡é¡¹ç›®': 'æ€»æˆå‘˜æ•°', 'æ•°å€¼': excelData.length},
                    {'ç»Ÿè®¡é¡¹ç›®': 'é«˜çº§ä¼šå‘˜äººæ•°', 'æ•°å€¼': excelData.filter(m => m.çº§åˆ« === 'é«˜çº§ä¼šå‘˜').length},
                    {'ç»Ÿè®¡é¡¹ç›®': 'ä¸­çº§ä¼šå‘˜äººæ•°', 'æ•°å€¼': excelData.filter(m => m.çº§åˆ« === 'ä¸­çº§ä¼šå‘˜').length},
                    {'ç»Ÿè®¡é¡¹ç›®': 'ä¼šå‘˜äººæ•°', 'æ•°å€¼': excelData.filter(m => m.çº§åˆ« === 'ä¼šå‘˜').length},
                    {'ç»Ÿè®¡é¡¹ç›®': 'æœ€å¤§å±‚çº§', 'æ•°å€¼': Math.max(...excelData.map(m => m.å±‚çº§)) + 1},
                    {'ç»Ÿè®¡é¡¹ç›®': 'å¯¼å‡ºæ—¶é—´', 'æ•°å€¼': new Date().toLocaleString('zh-CN')}
                ];
                
                const wsStats = XLSX.utils.json_to_sheet(statsData);
                wsStats['!cols'] = [{wch: 15}, {wch: 15}];
                XLSX.utils.book_append_sheet(wb, wsStats, "ç»Ÿè®¡ä¿¡æ¯");
                
                // ç”ŸæˆExcelæ–‡ä»¶
                const today = new Date();
                const dateStr = today.getFullYear() + 
                              String(today.getMonth() + 1).padStart(2, '0') + 
                              String(today.getDate()).padStart(2, '0');
                const fileName = `æ¶æ„å›¾_${dateStr}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('å¯¼å‡ºé”™è¯¯:', error);
                showNotification('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
            }
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('fileInput').click();
        }

        // å¤„ç†Excelæ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showNotification('è¯·é€‰æ‹©Excelæ–‡ä»¶æ ¼å¼(.xlsxæˆ–.xls)ï¼', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        showNotification('Excelæ–‡ä»¶ä¸ºç©ºï¼', 'error');
                        return;
                    }
                    
                    // æ„å»ºæ ‘ç»“æ„
                    const importedTeamData = buildTreeFromExcel(jsonData);
                    
                    if (!importedTeamData) {
                        showNotification('Excelæ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼', 'error');
                        return;
                    }
                    
                    // æ›´æ–°æ•°æ®
                    teamData = importedTeamData;
                    
                    // é‡ç½®çŠ¶æ€
                    selectedNode = null;
                    expandedNodes = {};
                    
                    // é‡æ–°æ¸²æŸ“
                    collectAllMembers();
                    renderTree();
                    updateParentSelect();
                    updateStatistics();
                    selectNode(teamData);
                    
                    showNotification('Excelæ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                    showNotification('æ•°æ®å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼ï¼', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // ä»Excelæ•°æ®æ„å»ºæ ‘ç»“æ„
        function buildTreeFromExcel(excelData) {
            // æŸ¥æ‰¾æ ¹èŠ‚ç‚¹ï¼ˆå®‰ç½®ä½ç½®ä¸º"æ ¹èŠ‚ç‚¹"æˆ–parentIdä¸ºç©ºï¼‰
            let rootNode = excelData.find(item => 
                item.å®‰ç½®ä½ç½® === 'æ ¹èŠ‚ç‚¹' || 
                !item.æ¨èäººID || 
                item.æ¨èäººID === ''
            );
            
            if (!rootNode) {
                showNotification('æœªæ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œè¯·ç¡®ä¿Excelä¸­æœ‰æ ¹èŠ‚ç‚¹æ•°æ®ï¼', 'error');
                return null;
            }
            
            // åˆ›å»ºèŠ‚ç‚¹æ˜ å°„
            const nodeMap = new Map();
            excelData.forEach(item => {
                nodeMap.set(item.æˆå‘˜ID, {
                    id: item.æˆå‘˜ID,
                    name: item.å§“å,
                    level: item.çº§åˆ«,
                    leftTeamSize: parseInt(item.å·¦åŒºå›¢é˜Ÿäººæ•°) || 0,
                    rightTeamSize: parseInt(item.å³åŒºå›¢é˜Ÿäººæ•°) || 0,
                    parentId: item.æ¨èäººID || null,
                    placement: item.å®‰ç½®ä½ç½® === 'å·¦åŒº' ? 'left' : 
                               item.å®‰ç½®ä½ç½® === 'å³åŒº' ? 'right' : 'root',
                    children: []
                });
            });
            
            // æ„å»ºæ ‘ç»“æ„
            const root = nodeMap.get(rootNode.æˆå‘˜ID);
            
            nodeMap.forEach((node, id) => {
                if (node.parentId && nodeMap.has(node.parentId)) {
                    const parent = nodeMap.get(node.parentId);
                    parent.children.push(node);
                }
            });
            
            return root;
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white fade-in z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        'fa-info-circle'
                    } mr-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocal() {
            try {
                const saveData = {
                    teamData: teamData,
                    expandedNodes: expandedNodes,
                    selectedNodeId: selectedNode ? selectedNode.id : null,
                    saveTime: new Date().toISOString(),
                    version: '1.0'
                };
                
                localStorage.setItem('teamManagementData', JSON.stringify(saveData));
                showNotification('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼', 'success');
                
                // æ›´æ–°ä¿å­˜çŠ¶æ€
                updateSaveStatus('æ‰‹åŠ¨ä¿å­˜æˆåŠŸ', 'success');
                document.getElementById('saveTimeDisplay').textContent = new Date().toLocaleTimeString('zh-CN');
                
                // åŒæ—¶åˆ›å»ºä¸‹è½½æ–‡ä»¶ä½œä¸ºå¤‡ä»½
                createDownloadFile(saveData);
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨æƒé™ï¼', 'error');
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        function loadFromLocal(silent = false) {
            try {
                const savedData = localStorage.getItem('teamManagementData');
                
                if (!savedData) {
                    if (!silent) {
                        showNotification('æ²¡æœ‰æ‰¾åˆ°æœ¬åœ°ä¿å­˜çš„æ•°æ®ï¼', 'error');
                    }
                    return false;
                }
                
                const data = JSON.parse(savedData);
                
                // éªŒè¯æ•°æ®å®Œæ•´æ€§
                if (!data.teamData || !data.teamData.id) {
                    if (!silent) {
                        showNotification('æœ¬åœ°æ•°æ®æ ¼å¼é”™è¯¯ï¼', 'error');
                    }
                    return false;
                }
                
                // æ¢å¤æ•°æ®
                teamData = data.teamData;
                expandedNodes = data.expandedNodes || {};
                
                // å¦‚æœæœ‰ä¿å­˜çš„é€‰ä¸­èŠ‚ç‚¹ï¼Œå°è¯•æ¢å¤
                if (data.selectedNodeId) {
                    selectedNode = findNodeById(teamData, data.selectedNodeId);
                }
                
                if (!silent) {
                    const saveTime = data.saveTime ? new Date(data.saveTime).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
                    showNotification(`æ•°æ®åŠ è½½æˆåŠŸï¼ä¿å­˜æ—¶é—´ï¼š${saveTime}`, 'success');
                    
                    // æ›´æ–°ä¿å­˜çŠ¶æ€
                    updateSaveStatus('æ•°æ®åŠ è½½æˆåŠŸ', 'success');
                    document.getElementById('saveTimeDisplay').textContent = saveTime.split(' ')[1] || saveTime;
                }
                
                return true;
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                if (!silent) {
                    showNotification('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥ï¼', 'error');
                }
                return false;
            }
        }

        // åˆ›å»ºä¸‹è½½æ–‡ä»¶
        function createDownloadFile(saveData) {
            try {
                const dataStr = JSON.stringify(saveData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const today = new Date();
                const dateStr = today.getFullYear() + 
                              String(today.getMonth() + 1).padStart(2, '0') + 
                              String(today.getDate()).padStart(2, '0');
                const exportFileDefaultName = `æ¶æ„å›¾_${dateStr}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
            } catch (error) {
                console.error('åˆ›å»ºä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
            }
        }

        // è‡ªåŠ¨ä¿å­˜
        function autoSave() {
            try {
                const saveData = {
                    teamData: teamData,
                    expandedNodes: expandedNodes,
                    selectedNodeId: selectedNode ? selectedNode.id : null,
                    saveTime: new Date().toISOString(),
                    version: '1.0'
                };
                
                localStorage.setItem('teamManagementData', JSON.stringify(saveData));
                
                // æ›´æ–°ä¿å­˜çŠ¶æ€
                updateSaveStatus('å·²è‡ªåŠ¨ä¿å­˜', 'success');
                document.getElementById('saveTimeDisplay').textContent = new Date().toLocaleTimeString('zh-CN');
                
                console.log('è‡ªåŠ¨ä¿å­˜å®Œæˆ:', new Date().toLocaleTimeString('zh-CN'));
                
            } catch (error) {
                console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                updateSaveStatus('è‡ªåŠ¨ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°ä¿å­˜çŠ¶æ€
        function updateSaveStatus(message, type = 'info') {
            const statusText = document.getElementById('statusText');
            const saveStatus = document.getElementById('saveStatus');
            
            statusText.textContent = message;
            
            // æ›´æ–°æ ·å¼
            saveStatus.className = type === 'success' ? 'text-green-600' : 
                                 type === 'error' ? 'text-red-600' : 
                                 'text-gray-600';
            
            // 3ç§’åæ¢å¤é»˜è®¤çŠ¶æ€
            setTimeout(() => {
                statusText.textContent = 'å°±ç»ª';
                saveStatus.className = 'text-gray-600';
            }, 3000);
        }

        // æ¸…é™¤æœ¬åœ°æ•°æ®
        function clearLocalData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°ä¿å­˜çš„æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('teamManagementData');
                showNotification('æœ¬åœ°æ•°æ®å·²æ¸…é™¤ï¼', 'success');
                
                // é‡ç½®ä¸ºé»˜è®¤æ•°æ®
                teamData = {
                    id: "1000",
                    name: "å¼ ä¸‰",
                    level: "é«˜çº§ä¼šå‘˜",
                    leftTeamSize: 0,
                    rightTeamSize: 0,
                    parentId: null,
                    placement: "root",
                    children: []
                };
                
                selectedNode = null;
                expandedNodes = {};
                
                collectAllMembers();
                renderTree();
                updateParentSelect();
                updateStatistics();
                selectNode(teamData);
            }
        }

        // åˆå§‹åŒ–å±•å¼€çŠ¶æ€
        expandedNodes[teamData.id] = true;
        if (teamData.children) {
            teamData.children.forEach(child => {
                expandedNodes[child.id] = true;
            });
        }

        // å½“å‰æŸ¥çœ‹è¯¦æƒ…çš„æˆå‘˜
        let currentDetailMember = null;

        // æ˜¾ç¤ºæˆå‘˜è¯¦æƒ…
        function showMemberDetail(memberId) {
            const member = findNodeById(teamData, memberId);
            if (!member) return;
            
            currentDetailMember = member;
            
            // è·å–æ¨èäººä¿¡æ¯
            let parentInfo = 'æ— ';
            if (member.parentId) {
                const parent = findNodeById(teamData, member.parentId);
                if (parent) {
                    parentInfo = `${parent.name} (ID: ${parent.id})`;
                }
            }
            
            // è·å–å­æˆå‘˜æ•°é‡
            const directChildrenCount = member.children ? member.children.length : 0;
            
            // è®¡ç®—ä¸‹çº§æ€»æ•°
            let totalSubordinates = 0;
            function countSubordinates(node) {
                let count = 0;
                if (node.children) {
                    count += node.children.length;
                    node.children.forEach(child => {
                        count += countSubordinates(child);
                    });
                }
                return count;
            }
            totalSubordinates = countSubordinates(member);
            
            // è·å–å®Œæ•´è·¯å¾„
            const memberPath = getMemberPath(memberId);
            
            // ç”Ÿæˆè¯¦ç»†å†…å®¹
            const detailContent = `
                <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <span class="text-gray-600 text-sm">æˆå‘˜ID:</span>
                            <div class="font-bold text-lg">${member.id}</div>
                        </div>
                        <div>
                            <span class="text-gray-600 text-sm">å§“å:</span>
                            <div class="font-bold text-lg">${member.name}</div>
                        </div>
                        <div>
                            <span class="text-gray-600 text-sm">ä¼šå‘˜çº§åˆ«:</span>
                            <div class="font-bold text-lg">${member.level}</div>
                        </div>
                        <div>
                            <span class="text-gray-600 text-sm">å®‰ç½®ä½ç½®:</span>
                            <div class="font-bold text-lg">
                                <span class="px-2 py-1 rounded ${member.placement === 'left' ? 'bg-blue-100 text-blue-800' : member.placement === 'right' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                    ${member.placement === 'left' ? 'å·¦åŒº' : member.placement === 'right' ? 'å³åŒº' : 'æ ¹èŠ‚ç‚¹'}
                                </span>
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-600 text-sm">æ¨èäºº:</span>
                            <div class="font-bold">${parentInfo}</div>
                        </div>
                        <div>
                            <span class="text-gray-600 text-sm">ç›´æ¥ä¸‹çº§:</span>
                            <div class="font-bold">${directChildrenCount} äºº</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-2">å›¢é˜Ÿç»Ÿè®¡</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>å·¦åŒºå›¢é˜Ÿ:</span>
                                <span class="font-bold">${member.leftTeamSize} äºº</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å³åŒºå›¢é˜Ÿ:</span>
                                <span class="font-bold">${member.rightTeamSize} äºº</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg">
                                <span>å›¢é˜Ÿæ€»è®¡:</span>
                                <span>${member.leftTeamSize + member.rightTeamSize} äºº</span>
                            </div>
                            <div class="flex justify-between">
                                <span>æ‰€æœ‰ä¸‹çº§:</span>
                                <span class="font-bold">${totalSubordinates} äºº</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-bold text-green-800 mb-2">å±‚çº§ä¿¡æ¯</h4>
                        <div class="space-y-2 text-sm">
                            <div>
                                <span class="text-gray-600">å®Œæ•´è·¯å¾„:</span>
                                <div class="font-bold mt-1 text-xs bg-gray-100 p-2 rounded">
                                    ${memberPath}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML = detailContent;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        // è·å–æˆå‘˜è·¯å¾„
        function getMemberPath(memberId) {
            console.log('=== è·å–æˆå‘˜è·¯å¾„ ===');
            console.log('ç›®æ ‡æˆå‘˜ID:', memberId);
            
            function buildPath(node, targetId, currentPath) {
                console.log('æ„å»ºè·¯å¾„ - å½“å‰èŠ‚ç‚¹:', node.name, 'ç›®æ ‡:', targetId, 'å½“å‰è·¯å¾„:', currentPath);
                
                if (node.id === targetId) {
                    console.log('ğŸ¯ æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹:', node.name);
                    return [...currentPath, node.name];
                }
                
                if (node.children) {
                    console.log('éå†å­èŠ‚ç‚¹æ•°é‡:', node.children.length);
                    for (let child of node.children) {
                        const foundPath = buildPath(child, targetId, [...currentPath, node.name]);
                        if (foundPath) return foundPath;
                    }
                }
                
                return null;
            }
            
            const fullPath = buildPath(teamData, memberId, []);
            const resultPath = fullPath ? fullPath.join(' â†’ ') : 'æœªæ‰¾åˆ°';
            
            console.log('ğŸ“ æœ€ç»ˆè·¯å¾„:', resultPath);
            console.log('æ‰€æœ‰è·¯å¾„èŠ‚ç‚¹:', fullPath);
            
            return resultPath;
        }

        // é€‰ä¸­è¯¦æƒ…ä¸­çš„æˆå‘˜
        function selectDetailMember() {
            if (currentDetailMember) {
                selectNode(currentDetailMember);
                closeDetailModal();
            }
        }

        // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
            currentDetailMember = null;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„æœ€ç»ˆæ£€æŸ¥
        console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        console.log('å›¢é˜Ÿæ•°æ®:', teamData);
        console.log('æ‰€æœ‰æˆå‘˜:', allMembers);
    </script>
</body>
</html>